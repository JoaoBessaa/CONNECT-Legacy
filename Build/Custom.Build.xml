<?xml version="1.0" encoding="utf-8"?>
<project xmlns="http://nant.sf.net/schemas/nant.xsd" name="Custom">

  <target name="Build.PublishZips">
    <call target="Build.PublishZip.Release.Installer"/>
    <call target="Build.PublishZip.Release.Interfaces"/>
    <call target="Build.Bundle.ESCs.Installers"/>
    <call target="Build.Bundle.SoapUI"/>
    <call target="Build.Bundle.Release.Properties"/>
  </target>

  <target name="Build.PublishZip.Release.Installer">
    <saveproperties file="${Common.Project.TempDirectory}\ReleaseInfo.txt" format="CommandLine" >
      <property name="CCNetLabel"/>
      <property name="CCNetBuildDate"/>
      <property name="CCNetBuildTime"/>
    </saveproperties>

    <property name="Installer.Zip.FileName" value="${ProjectFullName}_Binaries_${CCNetLabel}.zip"/>
    <property name="Installer.Zip.FilePath" value="${Common.Directory.Artifact.Path}\${Installer.Zip.FileName}"/>

    <zip zipfile="${Installer.Zip.FilePath}">
      <fileset basedir="${GlassFish.Deploy.Directory.Path}">
        <include name="**\*"/>
      </fileset>
      <fileset basedir="${Common.Directory.Install.Path}">
        <include name="**\*"/>
      </fileset>
      <fileset basedir="${Common.Directory.DBScripts.Path}" prefix="${Common.Directory.DBScripts.Name}">
        <include name="**\*"/>
      </fileset>
      <fileset basedir="${Common.Project.TempDirectory}">
        <include name="ReleaseInfo.txt"/>
      </fileset>
    </zip>

    <property name="Publish.Web.File.Name" value="${Installer.Zip.FileName}"/>
    <property name="Publish.Web.File.Path"	value="${Publish.WebPathRoot}/${Common.Directory.Artifact.Name}/${Publish.Web.File.Name}" />

    <call target="Publish.Link" />
  </target>

  <target name="Build.PublishZip.Release.Interfaces">
    <property name="Interfaces.Zip.FileName" value="${ProjectFullName}_Interfaces_${CCNetLabel}.zip"/>
    <property name="Interfaces.Zip.FilePath" value="${Common.Directory.Artifact.Path}\${Interfaces.Zip.FileName}"/>

    <zip zipfile="${Interfaces.Zip.FilePath}">
      <fileset basedir="${Common.Directory.Production.Path}\" >
        <include name="Common\Interfaces\**" />
      </fileset>
    </zip>

    <property name="Publish.Web.File.Name" value="${Interfaces.Zip.FileName}"/>
    <property name="Publish.Web.File.Path"	value="${Publish.WebPathRoot}/${Common.Directory.Artifact.Name}/${Publish.Web.File.Name}" />

    <call target="Publish.Link" />
  </target>

  <target name="Build.Bundle.Release.Properties">
    <property name="Properties.Properties.Directory" value="Blue"/>
    <property name="Properties.Zip.FileName" value="${ProjectFullName}_Properties_${Properties.Properties.Directory}_${CCNetLabel}.zip"/>
    <property name="Properties.Zip.FilePath" value="${Common.Directory.Artifact.Path}\${Properties.Zip.FileName}"/>

    <zip zipfile="${Properties.Zip.FilePath}">
      <fileset basedir="${Common.Directory.Production.Path}\Common\Properties\" >
        <include name="${Properties.Properties.Directory}\**" />
      </fileset>
    </zip>

    <property name="Publish.Web.File.Name" value="${Properties.Zip.FileName}"/>
    <property name="Publish.Web.File.Path"	value="${Publish.WebPathRoot}/${Common.Directory.Artifact.Name}/${Publish.Web.File.Name}" />

    <call target="Publish.Link" />

    <property name="Properties.Properties.Directory" value="Green"/>
    <property name="Properties.Zip.FileName" value="${ProjectFullName}_Properties_${Properties.Properties.Directory}_${CCNetLabel}.zip"/>
    <property name="Properties.Zip.FilePath" value="${Common.Directory.Artifact.Path}\${Properties.Zip.FileName}"/>

    <zip zipfile="${Properties.Zip.FilePath}">
      <fileset basedir="${Common.Directory.Production.Path}\Common\Properties\" >
        <include name="${Properties.Properties.Directory}\**" />
      </fileset>
    </zip>

    <property name="Publish.Web.File.Name" value="${Properties.Zip.FileName}"/>
    <property name="Publish.Web.File.Path"	value="${Publish.WebPathRoot}/${Common.Directory.Artifact.Name}/${Publish.Web.File.Name}" />

    <call target="Publish.Link" />

    <property name="Properties.Properties.Directory" value="Red"/>
    <property name="Properties.Zip.FileName" value="${ProjectFullName}_Properties_${Properties.Properties.Directory}_${CCNetLabel}.zip"/>
    <property name="Properties.Zip.FilePath" value="${Common.Directory.Artifact.Path}\${Properties.Zip.FileName}"/>

    <zip zipfile="${Properties.Zip.FilePath}">
      <fileset basedir="${Common.Directory.Production.Path}\Common\Properties\" >
        <include name="${Properties.Properties.Directory}\**" />
      </fileset>
    </zip>

    <property name="Publish.Web.File.Name" value="${Properties.Zip.FileName}"/>
    <property name="Publish.Web.File.Path"	value="${Publish.WebPathRoot}/${Common.Directory.Artifact.Name}/${Publish.Web.File.Name}" />

    <call target="Publish.Link" />

    <property name="Properties.Properties.Directory" value="Orange"/>
    <property name="Properties.Zip.FileName" value="${ProjectFullName}_Properties_${Properties.Properties.Directory}_${CCNetLabel}.zip"/>
    <property name="Properties.Zip.FilePath" value="${Common.Directory.Artifact.Path}\${Properties.Zip.FileName}"/>

    <zip zipfile="${Properties.Zip.FilePath}">
      <fileset basedir="${Common.Directory.Production.Path}\Common\Properties\" >
        <include name="${Properties.Properties.Directory}\**" />
      </fileset>
    </zip>

    <property name="Publish.Web.File.Name" value="${Properties.Zip.FileName}"/>
    <property name="Publish.Web.File.Path"	value="${Publish.WebPathRoot}/${Common.Directory.Artifact.Name}/${Publish.Web.File.Name}" />

    <call target="Publish.Link" />

  </target>

  <target name="Build.Bundle.ESCs.Installers">
    <property name="ESC.Zip.FileName" value="${ProjectFullName}_DynamicDocuments_${CCNetLabel}.zip"/>
    <property name="ESC.Zip.FilePath" value="${Common.Directory.Artifact.Path}\${ESC.Zip.FileName}"/>

    <zip zipfile="${ESC.Zip.FilePath}">
      <fileset basedir="${Common.Directory.Production.Path}\Adapters\Framework\AdapterCommonDataLayerEJB\dist\" prefix="bin" failonempty="true">
        <include name="AdapterCommonDataLayerEJB.jar"/>
      </fileset>
      <fileset basedir="${Common.Directory.Production.Path}\Adapters\Framework\AdapterDocumentAssemblyProxyEJB\dist\" prefix="bin" failonempty="true">
        <include name="AdapterDocumentAssemblyProxyEJB.jar"/>
      </fileset>
      <fileset basedir="${Common.Directory.Production.Path}\Adapters\Framework\AdapterDocumentRepositoryEJB\dist\" prefix="bin" failonempty="true">
        <include name="AdapterDocumentRepositoryEJB.jar"/>
      </fileset>
      <fileset basedir="${Common.Directory.Production.Path}\Adapters\Framework\DocumentManagerEJB\dist\" prefix="bin" failonempty="true">
        <include name="DocumentManagerEJB.jar"/>
      </fileset>
      <fileset basedir="${Common.Directory.Production.Path}\Adapters\Framework\NHINAdapterServiceEJB\dist\" prefix="bin" failonempty="true">
        <include name="NHINAdapterServiceEJB.jar"/>
      </fileset>
      <fileset basedir="${Common.Directory.Product.Path}\IntegrationTest\" prefix="SelfTest\DynamicDocumentTest" failonempty="true">
        <include name="DynamicDocumentTest-Internal-soapui-project.*"/>
      </fileset>
      <fileset basedir="${Common.Directory.Product.Path}\IntegrationTest\" prefix="SelfTest\DynamicDocumentTest" failonempty="true">
        <include name="DynamicDocumentTest-EndtoEnd-soapui-project.*"/>
      </fileset>
    </zip>

    <property name="Publish.Web.File.Name" value="${ESC.Zip.FileName}"/>
    <property name="Publish.Web.File.Path"	value="${Publish.WebPathRoot}/${Common.Directory.Artifact.Name}/${Publish.Web.File.Name}" />

    <call target="Publish.Link" />

  </target>

  <target name="Build.Bundle.SoapUI">
    <property name="SoapUI.Zip.FileName" value="${ProjectFullName}_Validation_Tests_${CCNetLabel}.zip"/>
    <property name="SoapUI.Zip.FilePath" value="${Common.Directory.Artifact.Path}\${SoapUI.Zip.FileName}"/>

    <zip zipfile="${SoapUI.Zip.FilePath}">
      <fileset basedir="${Common.Directory.Product.Path}\IntegrationTest\" prefix="SelfTest\EndToEndSelfTest" failonempty="true">
        <include name="EndToEndSelfTest-soapui-project.*"/>
      </fileset>
      <fileset basedir="${Common.Directory.Product.Path}\IntegrationTest\" prefix="SelfTest\InternalSelfTest" failonempty="true">
        <include name="InternalSelfTest-soapui-project.*"/>
      </fileset>
      <fileset basedir="${Common.Directory.Product.Path}\IntegrationTest\" prefix="SelfTest\OutboundSelfTest" failonempty="true">
        <include name="OutboundSelfTest-soapui-project.*"/>
      </fileset>
      <fileset basedir="${Common.Directory.Product.Path}\IntegrationTest\" prefix="SelfTest\PatientDiscovery" failonempty="true">
        <include name="PatientDiscovery-soapui-project.*"/>
      </fileset>
      <fileset basedir="${Common.Directory.Product.Path}\IntegrationTest\" prefix="SelfTest\ValidateServices" failonempty="true">
        <include name="ValidateServices-soapui-project.*"/>
      </fileset>
      <fileset basedir="${Common.Directory.Production.Path}\Common\Properties\Dev" >
        <include name="mpi.xml" />
        <include name="reidentification.xml" />
      </fileset>
      <fileset basedir="${Common.Directory.DBScripts.Path}\nhincdb" prefix="${Common.Directory.DBScripts.Name}">
        <include name="populateTestData.sql"/>
      </fileset>
    </zip>

    <property name="Publish.Web.File.Name" value="${SoapUI.Zip.FileName}"/>
    <property name="Publish.Web.File.Path"	value="${Publish.WebPathRoot}/${Common.Directory.Artifact.Name}/${Publish.Web.File.Name}" />

    <call target="Publish.Link" />

  </target>

  <target name="Common.FindBuild">
    <strings id="builds"/>

    <function execute="${ccnet::get-project-some-build-labels(CCNetRemotingUrl, ProjectNameToPullFrom, 15, 'builds') }"/>

    <loopthrough property="build">
      <items>
        <strings refid="builds"/>
      </items>
      <do>
        <trycatch>
          <try>
            <regex input="${build}" pattern="log\d+Lbuild\.${CCNetLabel}\.xml$"/>
            <break/>
          </try>
          <catch/>
        </trycatch>
      </do>
    </loopthrough>
  </target>

  <macrodef name="ask.published.good.build">
    <attributes>
      <attribute name="resultproperty" default="Build.Version" type="string"/>
      <attribute name="remotingurl" default="${CCNet.Server.Remoting.Url}" type="string"/>
      <attribute name="project" default="${ProjectName}-${ProjectCodeLineName}-Release" type="string"/>
    </attributes>
    <sequential>

      <strings id="goodbuilds"/>
      <strings id="builds"/>

      <function execute="${ccnet::get-project-some-build-labels(remotingurl, project, 15, 'builds') }"/>

      <property name="count" value="0"/>

      <loopthrough property="build">
        <items>
          <strings refid="builds"/>
        </items>
        <do>
          <trycatch>
            <try>
              <regex input="${build}" pattern="log\d+Lbuild\.(?'Label'.*)\.xml$"/>
              <function execute="${stringlist::add('goodbuilds', Label)}"/>
              <property name="count" value="${int::parse(count) + 1}"/>
            </try>
            <catch/>
          </trycatch>
          <break if="${int::parse(count) == 6}"/>
        </do>
      </loopthrough>

      <ask
          answer="${resultproperty}"
          caption="Choose which build?"
          question="Choose which build?">
        <options refid="goodbuilds" />
      </ask>
    </sequential>
  </macrodef>

  <macrodef name="get.published.artifact">
    <attributes>
      <attribute name="artifact" require="True" type="string"/>
      <attribute name="dest" require="True" type="string"/>
      <attribute name="build" require="True" type="string"/>
      <attribute name="remotingurl" default="${CCNet.Server.Remoting.Url}" type="string"/>
      <attribute name="project" default="${ProjectName}-${ProjectCodeLineName}-Release" type="string"/>
      <attribute name="webroot" default="http://${BuildServerHostName}/${ProjectName}-${ProjectCodeLineName}/${Common.Directory.ArtifactRoot.Name}" type="string"/>
      <attribute name="username" default="${Web.Credentials.UserName}" type="string"/>
      <attribute name="password" default="${Web.Credentials.Password}" type="string"/>
    </attributes>
    <sequential>

      <strings id="builds"/>
      <function execute="${ccnet::get-project-some-build-labels(remotingurl, project, 15, 'builds') }"/>
      <loopthrough property="BuildName">
        <items>
          <strings refid="builds"/>
        </items>
        <do>
          <trycatch>
            <try>
              <regex input="${BuildName}" pattern="log(?'BuildArchiveFolderName'\d+)Lbuild\.${build}\.xml$"/>
              <break/>
            </try>
            <catch/>
          </trycatch>
        </do>
      </loopthrough>

      <regex input="${BuildArchiveFolderName}" pattern="(?'Year'\d\d\d\d)(?'Month'\d\d)(?'Day'\d\d)"/>

      <mkdir dir="${path::get-directory-name(dest)}" unless="${directory::exists(path::get-directory-name(dest))}"/>

      <get
        dest="${dest}"
        src="${webroot}/${BuildArchiveFolderName}/${artifact}"
        verbose="true"
      >
        <credentials username="${username}" password="${password}"/>
      </get>
    </sequential>
  </macrodef>

</project>
