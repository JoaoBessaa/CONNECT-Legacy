<?xml version="1.0" encoding="UTF-8"?>
<project name="nhinc-integrationtests" default="soapui.run" basedir=".">
  <import file="../../../Product/Install/deploy.xml"/>

  <taskdef resource="net/sf/antcontrib/antlib.xml"/>

  <property name="IntegrationTest.Dir" value="C:/Projects/NHINC/2.4/Product/IntegrationTest"/>
  <property name="IntegrationTest.Results.Dir" value="${IntegrationTest.Dir}/results"/>
  <property name="SoapUI.Dir" value="C:/Program Files/eviware/soapUI-Pro-3.0.1/bin"/>

  <target name="soapui.run" depends="run-tests,build-report" />

  <target name="soapui.performance.run" depends="run.performance.tests,build-report" />

  <target name="init-tests">
    <delete dir="${IntegrationTest.Results.Dir}" failonerror="true"/>
    <mkdir dir="${IntegrationTest.Results.Dir}"/>
  </target>

  <target name="run-tests" depends="init-tests">
    <var name="counter" value="1"/>

    <for param="file">
      <path>
        <fileset dir="${IntegrationTest.Dir}">
          <include name="NhincPolicyEngineTest-soapui-project.xml"/>
          <include name="EntityPolicyEngineTest-soapui-project.xml"/>
          <include name="InternalSelfTest-soapui-project.xml"/>
          <include name="EndToEndSelfTest-soapui-project.xml"/>
          <include name="ValidateServices-soapui-project.xml"/>
          <include name="AdapterPIP-soapui-project.xml"/>
          <include name="DocQueryRetrieveSelfTest-soapui-project.xml"/>
          <include name="DocumentRetrieveXDSErrorValidation-soapui-project.xml"/>
          <include name="DocQueryAdditionalStoredQueries-soapui-project.xml"/>
          <include name="DocQueryXDSErrors-soapui-project.xml"/>
          <include name="PatientCorrelation-soapui-project.xml"/>
          <include name="AuditLogsforDocQandDocR-soapui-project.xml"/>
          <include name="DocRegistryAndRepository-soapui-project.xml"/>
          <include name="EntityDocQuery-soapui-project.xml"/>
          <include name="EntityDocRetrieve-soapui-project.xml"/>
          <include name="PolicyEngineInteractions-soapui-project.xml"/>
          <include name="AuditQueryTestHelper-soapui-project.xml"/>
          <include name="DocQuerytestsforUDDI-soapui-project.xml"/>
          <include name="QueryByState-soapui-project.xml"/>
          <include name="HIEM-PatientCentric-UDDItests-soapui-project.xml"/>
          <include name="HIEMTestsforUDDI-soapui-project.xml"/>
          <include name="XDRInboundTests-soapui-project.xml"/>
          <include name="XDRAdapterTests-soapui-project.xml"/>
          <include name="EntityXDRTests-soapui-project.xml"/>
          <include name="AuditLogQueryTestsforUDDI-soapui-project.xml"/>
          <include name="PatientDiscovery-soapui-project.xml"/>
		  <include name="PatientDiscoveryUDDIWithMultipleMocks-soapui-project2.4.xml"/>
        </fileset>
      </path>
      <sequential>
        <echo message="@{file}"/>
        <echo message="${counter}"/>

        <exec dir="${SoapUI.Dir}" executable="cmd.exe">
          <arg line="/c testrunner.bat -j -a -f${IntegrationTest.Results.Dir}/test_${counter} @{file}"/>
        </exec>

        <!-- 
          JUnit Report task requires that the input.xml files be unique. 
          The SoapUI executable outputs each test's report summary as report.xml need to rename each report.xml file. 
				-->
        <move file="${IntegrationTest.Results.Dir}/test_${counter}/report.xml" tofile="${IntegrationTest.Results.Dir}\test_${counter}\report${counter}.xml"/>
        <math result="counter" operand1="${counter}" operation="+" operand2="1" datatype="int"/>
      </sequential>
    </for>
  </target>

  <target name="run.performance.tests" depends="init-tests">
    <var name="counter" value="1"/>

    <for param="file">
      <path>
        <fileset dir="${IntegrationTest.Dir}">
          <include name="DocRetrieveLoadTest-soapui-project"/>
        </fileset>
      </path>
      <sequential>
        <echo message="@{file}"/>
        <echo message="${counter}"/>

        <exec dir="${SoapUI.Dir}" executable="cmd.exe">
          <arg line="/c testrunner.bat -r -f${IntegrationTest.Results.Dir}/test_${counter} @{file}"/>
        </exec>

        <!-- 
          JUnit Report task requires that the input.xml files be unique. 
          The SoapUI executable outputs each test's report summary as report.xml need to rename each report.xml file. 
				-->
        <move file="${IntegrationTest.Results.Dir}/test_${counter}/report.xml" tofile="${IntegrationTest.Results.Dir}\test_${counter}\report${counter}.xml"/>
        <math result="counter" operand1="${counter}" operation="+" operand2="1" datatype="int"/>
      </sequential>
    </for>
  </target>

  <target name="build-report" >
    <replace dir="${IntegrationTest.Results.Dir}" token="&lt;testsuites&gt;" value="">
      <include name="**/*.xml"/>
    </replace>

    <replace dir="${IntegrationTest.Results.Dir}" token="&lt;/testsuites&gt;" value="">
      <include name="**/*.xml"/>
    </replace>

    <junitreport 	todir="${IntegrationTest.Results.Dir}" tofile="IntegrationTests.xml">
      <fileset dir="${IntegrationTest.Results.Dir}">
        <include name="**/report*.xml"/>
      </fileset>
      <report format="frames" todir="${IntegrationTest.Results.Dir}/html" />
    </junitreport>
  </target>

</project>
