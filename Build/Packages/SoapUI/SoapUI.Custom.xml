<?xml version="1.0" encoding="utf-8"?>
<project xmlns="http://nant.sf.net/schemas/nant.xsd" name="SoapUI.Custom">

  <target name="SoapUI.RunTests" override="True">
    <property name="GlassFish.Domain.Server.Log.Dir.Path" value="${GlassFish.Home.Directory.Path}\domains\${GlassFish.Domain.Name}\logs\"/>
    <property name="GlassFish.Domain.Server.Log.File.Base.Name" value="server.log*"/>
    
    <call target="SoapUI.RunTests.Log.Clean"/>

    <trycatch>
      <try>
        <call target="SoapUI::SoapUI.RunTests"/>
      </try>
      <finally>
        <call target="SoapUI.RunTests.Log.Backup"/>
        <call target="SoapUI.RunTests.Log.Clean"/>
      </finally>
    </trycatch>
  </target>

  <target name="SoapUI.Performance.Test.Run" override="True">
    <property name="GlassFish.Domain.Server.Log.Dir.Path" value="${GlassFish.Home.Directory.Path}\domains\${GlassFish.Domain.Name}\logs\"/>
    <property name="GlassFish.Domain.Server.Log.File.Base.Name" value="server.log*"/>

    <call target="SoapUI.RunTests.Log.Clean"/>

    <trycatch>
      <try>
        <call target="SoapUI::SoapUI.Performance.Test.Run"/>
      </try>
      <finally>
        <!--<call target="SoapUI.RunTests.Log.Backup"/>-->
        <call target="SoapUI.RunTests.Log.Clean"/>
      </finally>
    </trycatch>
  </target>
  
  <target name="SoapUI.RunTests.Log.Clean" override="True">
    <call target="GlassFish.StopServer"/>
    <delete>
      <fileset basedir="${GlassFish.Domain.Server.Log.Dir.Path}">
        <include name="${GlassFish.Domain.Server.Log.File.Base.Name}"/>
      </fileset>
    </delete>
    <call target="GlassFish.StartServer"/>
  </target>
  
  <target name="SoapUI.RunTests.Log.Backup" override="True">
    <property name="Log.Backup.Zip.FileName" value="${ProjectFullName}_server_logs_${CCNetLabel}.zip"/>
    <property name="Log.Backup.Zip.FilePath" value="${Common.Directory.Artifact.Path}\${Log.Backup.Zip.FileName}"/>
    
    <call target="GlassFish.StopServer"/>
    <zip zipfile="${Log.Backup.Zip.FilePath}">
      <fileset basedir="${GlassFish.Domain.Server.Log.Dir.Path}">
        <include name="${GlassFish.Domain.Server.Log.File.Base.Name}"/>
      </fileset>
    </zip>

    <property name="Publish.Web.File.Name" value="${Log.Backup.Zip.FileName}"/>
    <property name="Publish.Web.File.Path"	value="${Publish.WebPathRoot}/${Common.Directory.Artifact.Name}/${Publish.Web.File.Name}" />

    <call target="Publish.Link"/>
  </target>
  
</project>