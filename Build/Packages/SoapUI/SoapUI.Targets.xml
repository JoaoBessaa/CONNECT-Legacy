<?xml version="1.0" encoding="utf-8"?>
<project xmlns="http://nant.sf.net/schemas/nant.xsd" name="SoapUI">

  <target name="SoapUI.RunTests">
		<copy 
      file="${SoapUI.Property.File.Path}"  
      tofile="${SoapUI.Root.Directory.Path}\default.properties" 
      overwrite="true"
    />
    
	  <trycatch>
		  <try>
        <ant
          target="soapui.run"
          buildfile="${Package.SoapUI.Directory.Path}\SoapUI.Ant.Targets.xml"
          logfile="${Ant.Log.Directory.Path}\soapui_log.xml"
        >
          <environment refid="SoapUI.EnvironmentVariables.RefId"/>
          <args/>
        </ant>
        <property name="Ant.Failure" value="False"/>
		  </try>
      <catch property="exception">
        <echo level="Error" message="${exception}"/>
        <property name="Ant.Failure" value="True"/>
      </catch>
	  </trycatch>
    
    <copy
			file='${SoapUI.Intermediate.Report.File.Path}'
			todir='${SoapUI.Report.Directory.Path}'
			if="${file::exists(SoapUI.Intermediate.Report.File.Path)}"
		/>
    
    <copy
			file='${SoapUI.Intermediate.Report.File.Path}'
			todir='${Common.Directory.Artifact.Path}'
			if="${file::exists(SoapUI.Intermediate.Report.File.Path)}"
		/>
	  
		<ifthenelse  test="${file::exists(SoapUI.Report.File.Path)}">
			<then>
				<property name="SoapUI.HasFailures" value="true"/>
				<xmlpeek
					file="${SoapUI.Report.File.Path}"
					property="SoapUI.HasFailures"
					xpath="boolean(/testsuites//testsuite[@errors>0] or /testsuites//testsuite[@failures>0])"
				/>

				<fail
					if="${SoapUI.HasFailures}"
					message="At least one SoapUI has failed.  Please check the SoapUI section for more details..."
				/>
			</then>
			<else>
				<fail message="It doesn't look like any SoapUI were run, so the build was failed!"/>
			</else>
		</ifthenelse>
		
  </target>

  <target name="SoapUI.Performance.Test.Run">
    <copy
      file="${SoapUI.Property.File.Path}"
      tofile="${SoapUI.Root.Directory.Path}\default.properties"
      overwrite="true"
    />

    <trycatch>
      <try>
        <ant
          target="soapui.performance.run"
          buildfile="${Package.SoapUI.Directory.Path}\SoapUI.Ant.Targets.xml"
          logfile="${Ant.Log.Directory.Path}\soapui_log.xml"
        >
          <environment refid="SoapUI.EnvironmentVariables.RefId"/>
          <args/>
        </ant>
        <property name="Ant.Failure" value="False"/>
      </try>
      <catch property="exception">
        <echo level="Error" message="${exception}"/>
        <property name="Ant.Failure" value="True"/>
      </catch>
    </trycatch>

    <copy
			file='${SoapUI.Intermediate.Report.File.Path}'
			todir='${SoapUI.Report.Directory.Path}'
			if="${file::exists(SoapUI.Intermediate.Report.File.Path)}"
		/>

    <copy
			file='${SoapUI.Intermediate.Report.File.Path}'
			todir='${Common.Directory.Artifact.Path}'
			if="${file::exists(SoapUI.Intermediate.Report.File.Path)}"
		/>

    <ifthenelse  test="${file::exists(SoapUI.Report.File.Path)}">
      <then>
        <property name="SoapUI.HasFailures" value="true"/>
        <xmlpeek
					file="${SoapUI.Report.File.Path}"
					property="SoapUI.HasFailures"
					xpath="boolean(/testsuites//testsuite[@errors>0] or /testsuites//testsuite[@failures>0])"
				/>

        <fail
					if="${SoapUI.HasFailures}"
					message="At least one SoapUI has failed.  Please check the SoapUI section for more details..."
				/>
      </then>
      <else>
        <fail message="It doesn't look like any SoapUI were run, so the build was failed!"/>
      </else>
    </ifthenelse>

  </target>
  
  <target name="SoapUI.ShowReport">
    <property name="Common.ShowReport.XmlFile" value="${SoapUI.Report.File.Path}"/>
    <property name="Common.ShowReport.HtmlFile" value="${SoapUI.Report.Directory.Path}\TestReport.html"/>
    <property name="Common.ShowReport.XslFile" value="${Common.Directory.Packages.Path}\SoapUI\junit-noframes.xsl"/>
    <property name="Common.ShowReport.DetailsFilePath" value=""/>

    <call target="Common.ShowReport"/>
  </target>
 
  <target name="SoapUI.SetUp">
    <delete dir="${SoapUI.Intermediate.Report.Directory.Path}" if="${directory::exists(SoapUI.Intermediate.Report.Directory.Path)}"/>
    <mkdir dir="${SoapUI.Intermediate.Report.Directory.Path}"/>

    <delete dir="${SoapUI.Report.Directory.Path}" if="${directory::exists(SoapUI.Report.Directory.Path)}"/>
    <mkdir dir="${SoapUI.Report.Directory.Path}"/>
  </target>

  <target name="SoapUI.TearDown">

  </target>
</project>
