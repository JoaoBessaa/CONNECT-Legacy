<?xml version="1.0" encoding="UTF-8"?>
<project name="nhinc" default="default" basedir=".">

  <description>compile, tests, deploy NHINC projects</description>

  <import file="build.lib.xml" />

  <condition property="progress-filepath" value="${java.io.tmpdir}/ant-progress.txt">
    <not>
      <isset property="progress-filepath" />
    </not>
  </condition>

  <target name="default" depends="build" description="Builds the NHIN-C solution." />

  <target name="build" description="Builds the NHIN-C solution." >
    <antcall target="do-to-projects">
      <param name="do-to-target" value="build"/>
    </antcall>
  </target>

  <target name="build-test" description="Cleans and then builds the NHIN-C solution." depends="init-tests">
    <antcall target="do-to-projects">
      <param name="do-to-target" value="build-test"/>
    </antcall>
  </target>

  <target name="clean" description="Cleans the NHIN-C solution." >
    <antcall target="do-to-projects">
      <param name="do-to-target" value="clean"/>
    </antcall>
  </target>

  <target name="clean-build" description="Cleans and then builds the NHIN-C solution.">
    <antcall target="do-to-projects">
      <param name="do-to-target" value="clean-build"/>
    </antcall>
  </target>

  <target name="clean-test" description="Cleans and then builds the NHIN-C solution." depends="init-tests">
    <antcall target="do-to-projects">
      <param name="do-to-target" value="clean-test"/>
    </antcall>
  </target>

  <target name="test" depends="init-tests">
    <antcall target="do-to-projects">
      <param name="do-to-target" value="test"/>
    </antcall>
  </target>

  <target name="deploy" depends="copy.deployable.artifacts">
    <runtarget target="deploy.to.production"/> 
  </target>

  <target name="copy.deployable.artifacts">
    <delete dir="${deployment.binaries.dir}"/>
    <mkdir dir="${deployment.binaries.dir}"/>

    <runtarget target="create.deploy.list.xml"/>

    <copy todir="${deployment.dir}/${deployment.environment.configuration.dir.name}" verbose="true" overwrite="true">
      <fileset dir="${root.project.directory.path}/Production/Common/Properties/${deployment.environment.configuration.dir.name}"/>
    </copy>
    
  	<copy todir="${deployment.interfaces.dir}" verbose="true" overwrite="true">
  	      <fileset dir="${root.project.directory.path}/Production/Common/Interfaces/src"/>
  	</copy>
  	
    
  	<antcall target="do-to-projects">
      <param name="do-to-target" value="copy.deployable.artifacts"/>
    </antcall>
  	
  </target>

  <target name="redeploy" depends="undeploy,deploy"/>
  
  <target name="undeploy">
    <runtarget target="create.deploy.list.xml"/>
    <var name="do-to-target" value="addentry.deploy.list.xml"/>
    <runtarget target="do-to-projects"/>
    <runtarget target="undeploy.from.production"/>
  </target>

  <target name="do-to-projects" description="calls the target specified in the property do-to-target on all the projects.">
    <property name="project.count" value="0" />
    <xmltask source="build.projects.xml">
      <call path="/projects/project">
        <actions>
          <math result="project.count" operand1="${project.count}" operation="+" operand2="1" datatype="int" />
        </actions> 
      </call>
    </xmltask>
    <property name="current.project.count" value="0" />
    <xmltask source="build.projects.xml">
      <call path="/projects/project">
        <param name="project.name" path="name/text()" />
        <param name="project.directory" path="directory/text()" />
        <actions>
          <math result="current.project.count" operand1="${current.project.count}" operation="+" operand2="1" datatype="int" />
          <echo message=" ******************** Start @{project.name} ${do-to-target} project ${current.project.count} of ${project.count} *************************" file="${progress-filepath}" />
          <echo message=" ******************** Start @{project.name} ${do-to-target} project ${current.project.count} of ${project.count} *************************" />
          <ant dir="${root.project.directory.path}/@{project.directory}" antfile="build.xml" inheritAll="false">
            <target name="${do-to-target}" />
          </ant>
          <echo message=" ******************** End @{project.name} ${do-to-target} project ${current.project.count} of ${project.count} *************************" file="${progress-filepath}" />
          <echo message=" ******************** End @{project.name} ${do-to-target} project ${current.project.count} of ${project.count} *************************" />
        </actions>
      </call>
    </xmltask>
  </target>

  <target name="init-tests">
    <delete includeemptydirs="true" failonerror="false">
      <fileset dir="./UnitTestResults" includes="*.xml"/>
      <fileset dir="./UnitTestResults/html" />
    </delete>
    <mkdir dir="./UnitTestResults"/>
  </target>

  <target name="UnitTestReport">
    <echo message=" ******************** Format JUnit Results *************************"/>
    <junitreport todir="./UnitTestResults" tofile="UnitTests.xml">
      <fileset dir="./UnitTestResults">
        <include name="TEST-*.xml"/>
      </fileset>
      <report format="frames" todir="./UnitTestResults/html"/>
    </junitreport>
    <echo message=" ******************** End Format JUnit Results **********************"/>
  </target>

  <target name="debug" description="Debugging Build Process">

  </target>

  <target name="echo_vars" description="Echo variables target." >
    <echoproperties/>
  </target>
</project>
